# 导航流程：从输入 URL 到页面展示，这中间发生了什么？

## 浏览器进程,渲染进程和网络进程的主要职责

浏览器进程: 主要负责用户交互,子进程管理和存储功能;  
网络进程: 面向浏览器进程和渲染进程,提供网络资源的下载;  
渲染进程: 将 JavaScript,Html,Css 和字体,媒体,图片等资源渲染成可以交互的界面;

## 从输入 Url 到页面展示

1. 用户输入  
   用户在浏览器地址栏输入内容查询,浏览器会根据规则判断输入内容是关键字搜索还是地址请求;  
   (1): 如果符合 URL 规则,地址栏会根据规则加上协议,生成完整的 URL;  
   (2): 如果是关键字搜索,地址栏会根据浏览器默认搜索引擎,生成完整的带关键字的 URL;  
   当用户点击回车确认搜索后,在当前页面替换为新页面之前,浏览器会为当前页面执行一次`beforeunload`事件,以允许用户在页面卸载之前进行一些清理工作;  
   还可以询问用户是否要离开当前页面(例如:当前页面有未提交的表单),用户可以通过该事件取消导航,浏览器便不再执行后续工作;  
   如果当前页面不存在`beforeunload`事件,或者确定导航, 浏览器标签页将会显示加载状态.
2. URL 请求  
   浏览器进程通过进程间通信(IPC)把 URL 请求资源发送给网络进程,网络进程接收到资源请求后,开始判断对应的资源是否存在缓存,如果存在缓存,则直接返回缓存资源,如果缓存不存在或者缓存过期,网络进程便会进入网络请求流程;  
   (1): DNS 请求获取 URL 的 IP 地址;  
   (2): 准备请求端口(HTTP 默认 80,HTTPS 默认 443);  
   (3): 如果是 HTTPS 协议,需要进行 TLS 连接;  
   (4): 等待 TCP 队列;  
   (5): 与服务器建立 TCP 连接,建立成功后,浏览器构建请求行,请求头等信息,并将和该域名相关的 Cookie 添加到请求头中,向服务器发送请求信息;  
   (6): 服务器接收到请求后,根据请求信息生成响应行,响应头,响应体并返回给网络进程;  
   (7): 网络进程接收到响应行和响应头之后,便开始解析响应头的内容;  
   (7.1): 网络进程解析响应头,发现返回的状态码是`301`,便会从响应头的 Location 字段读取`重定向`的地址,结束请求并重新发起`步骤2: URL请求`,如果状态码是 200,请求继续;  
   (7.2): 浏览器读取响应头的`Content-Type`字段,根据该字段的不同类型,做出不同的处理结果,例如:如果 `Content-Type`字段为`text/html`,便会准备渲染该资源,如果`Content-Type`字段为`application-octet-stream`,便会下载该文件,同时结束该 URL 请求流程 [查看更多 Content-Type](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Basics_of_HTTP/MIME_types)

3. 准备渲染进程  
   默认情况下,Chrome 会为每个标签页分配一个渲染进程,但在[其它情况下(共用渲染进程的情况)](./01-Chrome架构:%20仅仅打开一个页面,%20为什么会有四个进程.md),会与其它标签页共用渲染进程;

   渲染进程准备好后,还不能立即进行文档解析,因为此时文档数据还在网络进程中,并没有提交给渲染进程,所以需要将网络进程的数据提交给渲染进程;

4. 提交文档: 浏览器进程将网络进程中接受的 HTML 数据就提交给渲染进程;  
   (01): 网络进程将响应头提交给浏览器进程,浏览器进程接收到响应头后,向渲染进程发起 提交文档的消息;  
   (02): 渲染进程接收到浏览器进程的提交文档消息,会和网络进程建立传输数据的管道;  
   (03): 数据传输完毕后,渲染进程会返回确认提交信息给浏览器进程;  
   (04): 浏览器进程收到确认提交信息后,更新浏览器界面状态(安全状态,地址栏,前进后退历史状态),并更新 Web 页面;

5. 渲染阶段  
   文档提交后,渲染进程根据数据开始页面解析和子资源加载;[移步渲染流程](./05-渲染流程:%20HTML、CSS和JavaScript，是如何变成页面的？.md)
